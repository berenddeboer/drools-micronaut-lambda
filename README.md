# About

Example of a [Micronaut](https://micronaut.io/) Java lambda which uses
[Drools](https://www.drools.org/), and deploys this via GraalVM.

# Requirements

You need node 20 somehow. Probably best to install with your sytem
package manager, or use [nvm](https://github.com/nvm-sh/nvm).

Java was installed using [sdkman](https://sdkman.io/):

```
sdk install java 21.0.2-graalce
```

# Problems with this solution

The current solution has been iterated over thanks to help from the
Drools community, in particular feedback from Luca Molteni, and Mario
Fusco, who provided invaluable help in understanding how Drools
actually works.

The solution isn't perfect though. It has the following problems:

1. It needs both gradle and maven.

2. The reason it needs gradle is because of Micronaut. Well,
   technically Micronaut suports Maven, but we need to do some
   advanced stuff like rewriting the Dockerfile, not sure Maven
   supports that stuff. And frankly XML isn't very readable, it was
   never intended as a human format.

3. The reason it needs maven is because of Drools.

4. Drools by default generates Java code on the fly, then compiles
   it. That doesn't work with graalvm. So the code needs to be
   generated, and precompiled. That's what the kie maven plugin does.

   This means you need a `pom.xml` file in addition to `build.gradle`.

5. This could be solved by having a kie plugin for gradle.

6. It compiles the application twice. Gradle builds the application,
   then we build it again using maven, and overwrite the previously
   .jar generated by gradle with the one generated by maven.

# Testing any solution

Any improvements to the solution should pass this test:

```
cd java
./gradlew nativeTest
```

Note that there are various unsolved aggressive caching issues, so
change a `.java` file before running this test to make sure you
actually test the latest compilaton.

# Install

To actully deploy the lambda, first install the node packages:

```sh
npm install
```

Bootstrap your AWS account if you haven't done so (you will need to
have setup your access credentials):

```sh
npm run cdk bootstrap
```

# Build

Build the Java native lambda:

```sh
npm run build-native-lambda
```

# Deploy

Deploy your CDK stack:

```sh
npm run cdk deploy
```

This installs in us-east-1 by default.

# Test

From the command-line, if you have the aws cli installed:

```sh
aws lambda invoke --function-name micronaut-drools /dev/stdout
```

Or via the AWS console, find the "micronaut-drools" lambda, and on the
test tab supply this JSON:

```json
{
  "id": "color",
  "val": "red"
}
```

# How the project was created

Install the micronaut cli with sdkman:

```sh
sdk install micronaut
```

Then create the initial Java code:

```sh
mkdir drools-example
cd drools-example
cdk init app --language=typescript
mn create-function-app example.micronaut.lambda \
  --features=aws-lambda,graalvm \
  --build=gradle \
  --jdk=21
mv lambda java
```

Then copying in the [getting started Drools example](https://docs.drools.org/8.39.0.Final/drools-docs/docs-website/drools/getting-started/index.html).

## Useful commands

- `npm run build` compile typescript to js
- `npm run watch` watch for changes and compile
- `npm run test` perform the jest unit tests
- `npx cdk deploy` deploy this stack to your default AWS account/region
- `npx cdk diff` compare deployed stack with current state
- `npx cdk synth` emits the synthesized CloudFormation template

# Notes

If Java isn't compiled statically you get:

```
./func: /lib64/libc.so.6: version `GLIBC_2.32' not found (required by ./func)
./func: /lib64/libc.so.6: version `GLIBC_2.34' not found (required by ./func)
INIT_REPORT Init Duration: 10.17 ms Phase: init Status: error   Error Type: Runtime.ExitError
./func: /lib64/libc.so.6: version `GLIBC_2.32' not found (required by ./func)
./func: /lib64/libc.so.6: version `GLIBC_2.34' not found (required by ./func)
INIT_REPORT Init Duration: 4.87 ms  Phase: invoke   Status: error   Error Type: Runtime.ExitError
START RequestId: 00c4bc44-e48e-4e7d-ab38-a47800cd734b Version: $LATEST
RequestId: 00c4bc44-e48e-4e7d-ab38-a47800cd734b Error: Runtime exited with error: exit status 1
Runtime.ExitError
END RequestId: 00c4bc44-e48e-4e7d-ab38-a47800cd734b
REPORT RequestId: 00c4bc44-e48e-4e7d-ab38-a47800cd734b  Duration: 6.38 ms   Billed Duration: 7 ms   Memory Size: 1024 MB    Max Memory Used: 3 MB
```

# References

Getting started guides:

1. [Micronaut](https://guides.micronaut.io/latest/mn-application-aws-lambda-graalvm-gradle-java.html).
2. [Drools](https://docs.drools.org/8.39.0.Final/drools-docs/docs-website/drools/getting-started/index.html).
